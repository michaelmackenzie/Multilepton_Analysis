#include "interface/BTagWeight.hh"

using namespace CLFV;

//-------------------------------------------------------------------------------------------------------------------------
BTagWeight::BTagWeight(const int seed) {
  TFile* f = 0;
  const std::vector<int> working_points = {kLooseBTag, kMediumBTag, kTightBTag};
  const std::vector<int> years = {2016, 2017, 2018};
  rnd_ = new TRandom3(seed);
  verbose_ = 0;
  const TString cmssw = gSystem->Getenv("CMSSW_BASE");
  const TString path = (cmssw == "") ? "../scale_factors" : cmssw + "/src/CLFVAnalysis/scale_factors";
  for(int wp : working_points) {
    for(int year : years) {
      f = TFile::Open(Form("%s/btag_eff_wp_%i_mumu_%i.root", path.Data(), wp, year), "READ");
      TH2D* h;
      if(f) {
        //Get light quark histograms
        h = (TH2D*) f->Get("hLRatio");
        if(!h) std::cout << "BTagWeight::BTagWeight: Warning! No light quark histogram found for wp = "
                                         << wp << " year = " << year << std::endl;
        else {
          h = (TH2D*) h->Clone(Form("hL_%i_%i", year, wp));
          h->SetDirectory(0);
          histsL_[year][wp] = h;
        }
        //Get c-quark histograms
        h = (TH2D*) f->Get("hCRatio");
        if(!h) std::cout << "BTagWeight::BTagWeight: Warning! No c-quark histogram found for wp = "
                         << wp << " year = " << year << std::endl;
        else {
          h = (TH2D*) h->Clone(Form("hC_%i_%i", year, wp));
          h->SetDirectory(0);
          histsC_[year][wp] = h;
        }
        //Get b-quark histograms
        h = (TH2D*) f->Get("hBRatio");
        if(!h) std::cout << "BTagWeight::BTagWeight: Warning! No b-quark histogram found for wp = "
                                         << wp << " year = " << year << std::endl;
        else {
          h = (TH2D*) h->Clone(Form("hB_%i_%i", year, wp));
          h->SetDirectory(0);
          histsB_[year][wp] = h;
        }
        f->Close();
        delete f;
      }
    }
  }
}

//-------------------------------------------------------------------------------------------------------------------------
// Cleanup upon destructor call
BTagWeight::~BTagWeight() {
  for(std::map<int, std::map<int, TH2D*>>::iterator it = histsL_.begin(); it != histsL_.end(); it++) {
    std::map<int, TH2D*> val = it->second;
    for(std::map<int, TH2D*>::iterator it_2 = val.begin(); it_2 != val.end(); it_2++) {
      auto val2 = it_2->second;
      if(val2) delete val2;
    }
  }
  for(std::map<int, std::map<int, TH2D*>>::iterator it = histsC_.begin(); it != histsC_.end(); it++) {
    std::map<int, TH2D*> val = it->second;
    for(std::map<int, TH2D*>::iterator it_2 = val.begin(); it_2 != val.end(); it_2++) {
      auto val2 = it_2->second;
      if(val2) delete val2;
    }
  }
  for(std::map<int, std::map<int, TH2D*>>::iterator it = histsB_.begin(); it != histsB_.end(); it++) {
    std::map<int, TH2D*> val = it->second;
    for(std::map<int, TH2D*>::iterator it_2 = val.begin(); it_2 != val.end(); it_2++) {
      auto val2 = it_2->second;
      if(val2) delete val2;
    }
  }
}

//-------------------------------------------------------------------------------------------------------------------------
// Get the b-tag efficiency in MC
float BTagWeight::GetMCEff(const int WP, const int year, float jetpt, float jeteta, int jetflavor) {
  TH2D* h = 0;
  jetflavor = abs(jetflavor);
  if(jetpt > 999.) jetpt = 999.;
  else if(jetpt < 20.) jetpt = 20.;
  if(std::fabs(jeteta) > 2.4) {
    std::cout << "!!! BTagWeight::" << __func__ << " jet |eta| > 2.4!\n";
    jeteta = 2.39*jeteta/std::fabs(jeteta);
  }
  if(jetflavor == 4) //c-quark
    h = histsC_[year][WP];
  else if(jetflavor == 5) //b-quark
    h = histsB_[year][WP];
  else //light quark
    h = histsL_[year][WP];
  if(!h) {
    std::cout << "BTagWeight::" << __func__ << " Undefined histogram for wp = "
              << WP << " year = " << year << std::endl;
    return 1.;
  }
  const int binx = h->GetXaxis()->FindBin(jeteta);
  const int biny = h->GetYaxis()->FindBin(jetpt);
  float eff = h->GetBinContent(binx, biny);
  if(eff < 0.) {
    std::cout << "BTagWeight::" << __func__ << ": Warning! MC Eff < 0 = " << eff
              << " jetpt = " << jetpt << " jeteta = " << jeteta
              << " jetflavor = " << jetflavor << std::endl;
    eff = 0.000001;
  }
  return eff;
}


//-------------------------------------------------------------------------------------------------------------------------
void BTagWeight::GetSystematic(const int WP, const int year, float jetpt, int jetFlavor,
                               float& up, float& down) {
  float x(jetpt);
  jetFlavor = abs(jetFlavor);
  x = std::max(20.001f, std::min(999.f, x));
  up = 1.; down = 1.;

  int flavor = 2; //u,d,s,g
  if(jetFlavor == 5) flavor = 0; //true b-jet
  else if(jetFlavor == 4) flavor = 1; //true c-jet

  ///////////////////////////////////////////
  // 2018 Systematics
  ///////////////////////////////////////////

  if(year == 2018) {
    ///////////////////////////////////////////
    // 2018 Loose WP
    if(WP == kLooseBTag) {
      if     (flavor == 1 && x > 20  && x < 30  ) down = 0.873139+((0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18))))))-0.11263331770896912)   ;
      else if(flavor == 1 && x > 30  && x < 50  ) down = 0.873139+((0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18))))))-0.035774830728769302)  ;
      else if(flavor == 1 && x > 50  && x < 70  ) down = 0.873139+((0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18))))))-0.048977665603160858)  ;
      else if(flavor == 1 && x > 70  && x < 100 ) down = 0.873139+((0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18))))))-0.029415970668196678)  ;
      else if(flavor == 1 && x > 100 && x < 140 ) down = 0.873139+((0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18))))))-0.02761555090546608)   ;
      else if(flavor == 1 && x > 140 && x < 200 ) down = 0.873139+((0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18))))))-0.027591491118073463)  ;
      else if(flavor == 1 && x > 200 && x < 300 ) down = 0.873139+((0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18))))))-0.030103476718068123)  ;
      else if(flavor == 1 && x > 300 && x < 600 ) down = 0.873139+((0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18))))))-0.10650250315666199)   ;
      else if(flavor == 1 && x > 600 && x < 1000) down = 0.873139+((0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18))))))-0.22497090697288513)   ;
      else if(flavor == 0 && x > 20  && x < 30  ) down = 0.873139+((0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18))))))-0.045053325593471527)  ;
      else if(flavor == 0 && x > 30  && x < 50  ) down = 0.873139+((0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18))))))-0.014309932477772236)  ;
      else if(flavor == 0 && x > 50  && x < 70  ) down = 0.873139+((0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18))))))-0.019591066986322403)  ;
      else if(flavor == 0 && x > 70  && x < 100 ) down = 0.873139+((0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18))))))-0.011766388081014156)  ;
      else if(flavor == 0 && x > 100 && x < 140 ) down = 0.873139+((0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18))))))-0.011046220548450947)  ;
      else if(flavor == 0 && x > 140 && x < 200 ) down = 0.873139+((0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18))))))-0.01103659626096487)   ;
      else if(flavor == 0 && x > 200 && x < 300 ) down = 0.873139+((0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18))))))-0.012041390873491764)  ;
      else if(flavor == 0 && x > 300 && x < 600 ) down = 0.873139+((0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18))))))-0.042601000517606735)  ;
      else if(flavor == 0 && x > 600 && x < 1000) down = 0.873139+((0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18))))))-0.089988365769386292)  ;
      if     (flavor == 1 && x > 20  && x < 30  ) up   = (0.873139+(0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18)))))))+0.11263331770896912   ;
      else if(flavor == 1 && x > 30  && x < 50  ) up   = (0.873139+(0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18)))))))+0.035774830728769302  ;
      else if(flavor == 1 && x > 50  && x < 70  ) up   = (0.873139+(0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18)))))))+0.048977665603160858  ;
      else if(flavor == 1 && x > 70  && x < 100 ) up   = (0.873139+(0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18)))))))+0.029415970668196678  ;
      else if(flavor == 1 && x > 100 && x < 140 ) up   = (0.873139+(0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18)))))))+0.02761555090546608   ;
      else if(flavor == 1 && x > 140 && x < 200 ) up   = (0.873139+(0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18)))))))+0.027591491118073463  ;
      else if(flavor == 1 && x > 200 && x < 300 ) up   = (0.873139+(0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18)))))))+0.030103476718068123  ;
      else if(flavor == 1 && x > 300 && x < 600 ) up   = (0.873139+(0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18)))))))+0.10650250315666199   ;
      else if(flavor == 1 && x > 600 && x < 1000) up   = (0.873139+(0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18)))))))+0.22497090697288513   ;
      else if(flavor == 0 && x > 20  && x < 30  ) up   = (0.873139+(0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18)))))))+0.045053325593471527  ;
      else if(flavor == 0 && x > 30  && x < 50  ) up   = (0.873139+(0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18)))))))+0.014309932477772236  ;
      else if(flavor == 0 && x > 50  && x < 70  ) up   = (0.873139+(0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18)))))))+0.019591066986322403  ;
      else if(flavor == 0 && x > 70  && x < 100 ) up   = (0.873139+(0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18)))))))+0.011766388081014156  ;
      else if(flavor == 0 && x > 100 && x < 140 ) up   = (0.873139+(0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18)))))))+0.011046220548450947  ;
      else if(flavor == 0 && x > 140 && x < 200 ) up   = (0.873139+(0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18)))))))+0.01103659626096487   ;
      else if(flavor == 0 && x > 200 && x < 300 ) up   = (0.873139+(0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18)))))))+0.012041390873491764  ;
      else if(flavor == 0 && x > 300 && x < 600 ) up   = (0.873139+(0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18)))))))+0.042601000517606735  ;
      else if(flavor == 0 && x > 600 && x < 1000) up   = (0.873139+(0.00420739*(log(x+19)*(log(x+18)*(3-(0.380932*log(x+18)))))))+0.089988365769386292  ;

      if(flavor == 2 && x > 20 && x < 1000) down = (1.61341+-0.000566321*x+1.99464e-07*x*x+-5.09199/x)*(1-(0.0631436+7.87525e-05*x+-1.10405e-07*x*x));
      if(flavor == 2 && x > 20 && x < 1000) up   = (1.61341+-0.000566321*x+1.99464e-07*x*x+-5.09199/x)*(1+(0.0631436+7.87525e-05*x+-1.10405e-07*x*x));
    }

    ///////////////////////////////////////////
    // 2018 Medium WP
    if(WP == kMediumBTag) {
      if     (flavor == 1 && x > 20  && x < 30  ) down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.13967660069465637   ;
      else if(flavor == 1 && x > 30  && x < 50  ) down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.049122259020805359  ;
      else if(flavor == 1 && x > 50  && x < 70  ) down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.043598789721727371  ;
      else if(flavor == 1 && x > 70  && x < 100 ) down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.038782715797424316  ;
      else if(flavor == 1 && x > 100 && x < 140 ) down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.036949444562196732  ;
      else if(flavor == 1 && x > 140 && x < 200 ) down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.043523617088794708  ;
      else if(flavor == 1 && x > 200 && x < 300 ) down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.04994809627532959   ;
      else if(flavor == 1 && x > 300 && x < 600 ) down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.090836621820926666  ;
      else if(flavor == 1 && x > 600 && x < 1000) down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.16102308034896851   ;
      else if(flavor == 0 && x > 20  && x < 30  ) down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.046558864414691925  ;
      else if(flavor == 0 && x > 30  && x < 50  ) down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.016374086961150169  ;
      else if(flavor == 0 && x > 50  && x < 70  ) down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.014532930217683315  ;
      else if(flavor == 0 && x > 70  && x < 100 ) down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.012927571311593056  ;
      else if(flavor == 0 && x > 100 && x < 140 ) down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.012316481210291386  ;
      else if(flavor == 0 && x > 140 && x < 200 ) down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.014507872052490711  ;
      else if(flavor == 0 && x > 200 && x < 300 ) down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.016649365425109863  ;
      else if(flavor == 0 && x > 300 && x < 600 ) down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.030278874561190605  ;
      else if(flavor == 0 && x > 600 && x < 1000) down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.053674362599849701  ;
      if     (flavor == 1 && x > 20  && x < 30  ) up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.13967660069465637   ;
      else if(flavor == 1 && x > 30  && x < 50  ) up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.049122259020805359  ;
      else if(flavor == 1 && x > 50  && x < 70  ) up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.043598789721727371  ;
      else if(flavor == 1 && x > 70  && x < 100 ) up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.038782715797424316  ;
      else if(flavor == 1 && x > 100 && x < 140 ) up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.036949444562196732  ;
      else if(flavor == 1 && x > 140 && x < 200 ) up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.043523617088794708  ;
      else if(flavor == 1 && x > 200 && x < 300 ) up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.04994809627532959   ;
      else if(flavor == 1 && x > 300 && x < 600 ) up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.090836621820926666  ;
      else if(flavor == 1 && x > 600 && x < 1000) up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.16102308034896851   ;
      else if(flavor == 0 && x > 20  && x < 30  ) up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.046558864414691925  ;
      else if(flavor == 0 && x > 30  && x < 50  ) up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.016374086961150169  ;
      else if(flavor == 0 && x > 50  && x < 70  ) up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.014532930217683315  ;
      else if(flavor == 0 && x > 70  && x < 100 ) up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.012927571311593056  ;
      else if(flavor == 0 && x > 100 && x < 140 ) up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.012316481210291386  ;
      else if(flavor == 0 && x > 140 && x < 200 ) up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.014507872052490711  ;
      else if(flavor == 0 && x > 200 && x < 300 ) up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.016649365425109863  ;
      else if(flavor == 0 && x > 300 && x < 600 ) up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.030278874561190605  ;
      else if(flavor == 0 && x > 600 && x < 1000) up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.053674362599849701  ;

      if(flavor == 2 && x > 20 && x < 1000) down = (1.59373+-0.00113028*x+8.66631e-07*x*x+-1.10505/x)*(1-(0.142253+0.000227323*x+-2.71704e-07*x*x));
      if(flavor == 2 && x > 20 && x < 1000) up   = (1.59373+-0.00113028*x+8.66631e-07*x*x+-1.10505/x)*(1+(0.142253+0.000227323*x+-2.71704e-07*x*x));
    }

    ///////////////////////////////////////////
    // 2018 Tight WP
    if(WP == kTightBTag) {
      if     (flavor == 1 && x > 20  && x < 30  ) down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.15082257986068726    ;
      else if(flavor == 1 && x > 30  && x < 50  ) down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.054858319461345673   ;
      else if(flavor == 1 && x > 50  && x < 70  ) down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.053491078317165375   ;
      else if(flavor == 1 && x > 70  && x < 100 ) down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.048742711544036865   ;
      else if(flavor == 1 && x > 100 && x < 140 ) down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.04667256772518158    ;
      else if(flavor == 1 && x > 140 && x < 200 ) down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.047940321266651154   ;
      else if(flavor == 1 && x > 200 && x < 300 ) down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.064067237079143524   ;
      else if(flavor == 1 && x > 300 && x < 600 ) down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.10955213010311127    ;
      else if(flavor == 1 && x > 600 && x < 1000) down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.16617907583713531    ;
      else if(flavor == 0 && x > 20  && x < 30  ) down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.043092165142297745   ;
      else if(flavor == 0 && x > 30  && x < 50  ) down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.01567380502820015    ;
      else if(flavor == 0 && x > 50  && x < 70  ) down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.015283165499567986   ;
      else if(flavor == 0 && x > 70  && x < 100 ) down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.013926489278674126   ;
      else if(flavor == 0 && x > 100 && x < 140 ) down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.01333501935005188    ;
      else if(flavor == 0 && x > 140 && x < 200 ) down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.013697234913706779   ;
      else if(flavor == 0 && x > 200 && x < 300 ) down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.018304925411939621   ;
      else if(flavor == 0 && x > 300 && x < 600 ) down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.031300608068704605   ;
      else if(flavor == 0 && x > 600 && x < 1000) down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.047479737550020218   ;
      if     (flavor == 1 && x > 20  && x < 30  ) up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.15082257986068726    ;
      else if(flavor == 1 && x > 30  && x < 50  ) up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.054858319461345673   ;
      else if(flavor == 1 && x > 50  && x < 70  ) up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.053491078317165375   ;
      else if(flavor == 1 && x > 70  && x < 100 ) up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.048742711544036865   ;
      else if(flavor == 1 && x > 100 && x < 140 ) up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.04667256772518158    ;
      else if(flavor == 1 && x > 140 && x < 200 ) up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.047940321266651154   ;
      else if(flavor == 1 && x > 200 && x < 300 ) up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.064067237079143524   ;
      else if(flavor == 1 && x > 300 && x < 600 ) up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.10955213010311127    ;
      else if(flavor == 1 && x > 600 && x < 1000) up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.16617907583713531    ;
      else if(flavor == 0 && x > 20  && x < 30  ) up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.043092165142297745   ;
      else if(flavor == 0 && x > 30  && x < 50  ) up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.01567380502820015    ;
      else if(flavor == 0 && x > 50  && x < 70  ) up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.015283165499567986   ;
      else if(flavor == 0 && x > 70  && x < 100 ) up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.013926489278674126   ;
      else if(flavor == 0 && x > 100 && x < 140 ) up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.01333501935005188    ;
      else if(flavor == 0 && x > 140 && x < 200 ) up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.013697234913706779   ;
      else if(flavor == 0 && x > 200 && x < 300 ) up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.018304925411939621   ;
      else if(flavor == 0 && x > 300 && x < 600 ) up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.031300608068704605   ;
      else if(flavor == 0 && x > 600 && x < 1000) up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.047479737550020218   ;

      if(flavor == 2 && x > 20 && x < 1000) down = (1.77088+-0.00371551*x+5.86489e-06*x*x+-3.01178e-09*x*x*x)*(1-(0.223324+0.000231341*x+-2.34362e-07*x*x));
      if(flavor == 2 && x > 20 && x < 1000) up   = (1.77088+-0.00371551*x+5.86489e-06*x*x+-3.01178e-09*x*x*x)*(1+(0.223324+0.000231341*x+-2.34362e-07*x*x));
    }
  }

  ///////////////////////////////////////////
  // 2017 Systematics
  ///////////////////////////////////////////

  if(year == 2017) {
    ///////////////////////////////////////////
    // 2017 Loose WP
    if(WP == kLooseBTag) {
      if     (flavor == 1 && x > 20  && x < 30  ) down = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))-0.18561962246894836  ;
      else if(flavor == 1 && x > 30  && x < 50  ) down = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))-0.052777081727981567 ;
      else if(flavor == 1 && x > 50  && x < 70  ) down = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))-0.044571302831172943 ;
      else if(flavor == 1 && x > 70  && x < 100 ) down = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))-0.047755878418684006 ;
      else if(flavor == 1 && x > 100 && x < 140 ) down = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))-0.047674369066953659 ;
      else if(flavor == 1 && x > 140 && x < 200 ) down = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))-0.051324609667062759 ;
      else if(flavor == 1 && x > 200 && x < 300 ) down = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))-0.079239755868911743 ;
      else if(flavor == 1 && x > 300 && x < 600 ) down = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))-0.091035366058349609 ;
      else if(flavor == 1 && x > 600 && x < 1000) down = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))-0.11563461273908615  ;
      else if(flavor == 0 && x > 20  && x < 30  ) down = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))-0.074247851967811584 ;
      else if(flavor == 0 && x > 30  && x < 50  ) down = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))-0.021110832691192627 ;
      else if(flavor == 0 && x > 50  && x < 70  ) down = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))-0.017828520387411118 ;
      else if(flavor == 0 && x > 70  && x < 100 ) down = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))-0.019102351740002632 ;
      else if(flavor == 0 && x > 100 && x < 140 ) down = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))-0.019069747999310493 ;
      else if(flavor == 0 && x > 140 && x < 200 ) down = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))-0.020529843866825104 ;
      else if(flavor == 0 && x > 200 && x < 300 ) down = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))-0.031695902347564697 ;
      else if(flavor == 0 && x > 300 && x < 600 ) down = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))-0.036414146423339844 ;
      else if(flavor == 0 && x > 600 && x < 1000) down = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))-0.04625384509563446  ;
      if     (flavor == 1 && x > 20  && x < 30  ) up   = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))+0.18561962246894836  ;
      else if(flavor == 1 && x > 30  && x < 50  ) up   = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))+0.052777081727981567 ;
      else if(flavor == 1 && x > 50  && x < 70  ) up   = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))+0.044571302831172943 ;
      else if(flavor == 1 && x > 70  && x < 100 ) up   = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))+0.047755878418684006 ;
      else if(flavor == 1 && x > 100 && x < 140 ) up   = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))+0.047674369066953659 ;
      else if(flavor == 1 && x > 140 && x < 200 ) up   = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))+0.051324609667062759 ;
      else if(flavor == 1 && x > 200 && x < 300 ) up   = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))+0.079239755868911743 ;
      else if(flavor == 1 && x > 300 && x < 600 ) up   = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))+0.091035366058349609 ;
      else if(flavor == 1 && x > 600 && x < 1000) up   = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))+0.11563461273908615  ;
      else if(flavor == 0 && x > 20  && x < 30  ) up   = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))+0.074247851967811584 ;
      else if(flavor == 0 && x > 30  && x < 50  ) up   = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))+0.021110832691192627 ;
      else if(flavor == 0 && x > 50  && x < 70  ) up   = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))+0.017828520387411118 ;
      else if(flavor == 0 && x > 70  && x < 100 ) up   = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))+0.019102351740002632 ;
      else if(flavor == 0 && x > 100 && x < 140 ) up   = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))+0.019069747999310493 ;
      else if(flavor == 0 && x > 140 && x < 200 ) up   = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))+0.020529843866825104 ;
      else if(flavor == 0 && x > 200 && x < 300 ) up   = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))+0.031695902347564697 ;
      else if(flavor == 0 && x > 300 && x < 600 ) up   = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))+0.036414146423339844 ;
      else if(flavor == 0 && x > 600 && x < 1000) up   = (1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x))))+0.04625384509563446  ;

      if(flavor == 2 && x > 20 && x < 1000) down = (1.43763+-0.000337048*x+2.22072e-07*x*x+-4.85489/x)*(1-(0.0526747+8.27233e-05*x+-1.12281e-07*x*x));
      if(flavor == 2 && x > 20 && x < 1000) up   = (1.43763+-0.000337048*x+2.22072e-07*x*x+-4.85489/x)*(1+(0.0526747+8.27233e-05*x+-1.12281e-07*x*x));
    }

    ///////////////////////////////////////////
    // 2017 Medium WP
    if(WP == kMediumBTag) {
      if     (flavor == 1 && x > 20  && x < 30  ) down = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))-0.22882774472236633 ;
      else if(flavor == 1 && x > 30  && x < 50  ) down = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))-0.079194873571395874;
      else if(flavor == 1 && x > 50  && x < 70  ) down = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))-0.07602342963218689 ;
      else if(flavor == 1 && x > 70  && x < 100 ) down = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))-0.073120191693305969;
      else if(flavor == 1 && x > 100 && x < 140 ) down = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))-0.078529126942157745;
      else if(flavor == 1 && x > 140 && x < 200 ) down = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))-0.086113773286342621;
      else if(flavor == 1 && x > 200 && x < 300 ) down = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))-0.11148297786712646 ;
      else if(flavor == 1 && x > 300 && x < 600 ) down = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))-0.10986694693565369 ;
      else if(flavor == 1 && x > 600 && x < 1000) down = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))-0.12645691633224487 ;
      else if(flavor == 0 && x > 20  && x < 30  ) down = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))-0.076275914907455444;
      else if(flavor == 0 && x > 30  && x < 50  ) down = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))-0.026398291811347008;
      else if(flavor == 0 && x > 50  && x < 70  ) down = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))-0.02534114383161068 ;
      else if(flavor == 0 && x > 70  && x < 100 ) down = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))-0.02437339723110199 ;
      else if(flavor == 0 && x > 100 && x < 140 ) down = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))-0.026176376268267632;
      else if(flavor == 0 && x > 140 && x < 200 ) down = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))-0.02870459109544754 ;
      else if(flavor == 0 && x > 200 && x < 300 ) down = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))-0.037160992622375488;
      else if(flavor == 0 && x > 300 && x < 600 ) down = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))-0.036622315645217896;
      else if(flavor == 0 && x > 600 && x < 1000) down = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))-0.04215230792760849 ;
      if     (flavor == 1 && x > 20  && x < 30  ) up   = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))+0.22882774472236633 ;
      else if(flavor == 1 && x > 30  && x < 50  ) up   = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))+0.079194873571395874;
      else if(flavor == 1 && x > 50  && x < 70  ) up   = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))+0.07602342963218689 ;
      else if(flavor == 1 && x > 70  && x < 100 ) up   = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))+0.073120191693305969;
      else if(flavor == 1 && x > 100 && x < 140 ) up   = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))+0.078529126942157745;
      else if(flavor == 1 && x > 140 && x < 200 ) up   = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))+0.086113773286342621;
      else if(flavor == 1 && x > 200 && x < 300 ) up   = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))+0.11148297786712646 ;
      else if(flavor == 1 && x > 300 && x < 600 ) up   = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))+0.10986694693565369 ;
      else if(flavor == 1 && x > 600 && x < 1000) up   = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))+0.12645691633224487 ;
      else if(flavor == 0 && x > 20  && x < 30  ) up   = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))+0.076275914907455444;
      else if(flavor == 0 && x > 30  && x < 50  ) up   = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))+0.026398291811347008;
      else if(flavor == 0 && x > 50  && x < 70  ) up   = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))+0.02534114383161068 ;
      else if(flavor == 0 && x > 70  && x < 100 ) up   = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))+0.02437339723110199 ;
      else if(flavor == 0 && x > 100 && x < 140 ) up   = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))+0.026176376268267632;
      else if(flavor == 0 && x > 140 && x < 200 ) up   = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))+0.02870459109544754 ;
      else if(flavor == 0 && x > 200 && x < 300 ) up   = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))+0.037160992622375488;
      else if(flavor == 0 && x > 300 && x < 600 ) up   = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))+0.036622315645217896;
      else if(flavor == 0 && x > 600 && x < 1000) up   = (0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x))))+0.04215230792760849 ;

      if(flavor == 2 && x > 20 && x < 1000) down = (1.40779+-0.00094558*x+8.74982e-07*x*x+-4.67814/x)*(1-(0.100661+0.000294578*x+-3.2739e-07*x*x));
      if(flavor == 2 && x > 20 && x < 1000) up   = (1.40779+-0.00094558*x+8.74982e-07*x*x+-4.67814/x)*(1+(0.100661+0.000294578*x+-3.2739e-07*x*x));
    }

    ///////////////////////////////////////////
    // 2017 Tight WP
    if(WP == kTightBTag) {
      if     (flavor == 1 && x > 20  && x < 30  ) down = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))-0.29166096448898315  ;
      else if(flavor == 1 && x > 30  && x < 50  ) down = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))-0.11922945827245712  ;
      else if(flavor == 1 && x > 50  && x < 70  ) down = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))-0.10877241939306259  ;
      else if(flavor == 1 && x > 70  && x < 100 ) down = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))-0.096656471490859985 ;
      else if(flavor == 1 && x > 100 && x < 140 ) down = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))-0.10989730805158615  ;
      else if(flavor == 1 && x > 140 && x < 200 ) down = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))-0.12157130241394043  ;
      else if(flavor == 1 && x > 200 && x < 300 ) down = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))-0.1550547182559967   ;
      else if(flavor == 1 && x > 300 && x < 600 ) down = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))-0.1779310405254364   ;
      else if(flavor == 1 && x > 600 && x < 1000) down = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))-0.14317682385444641  ;
      else if(flavor == 0 && x > 20  && x < 30  ) down = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))-0.083331704139709473 ;
      else if(flavor == 0 && x > 30  && x < 50  ) down = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))-0.034065559506416321 ;
      else if(flavor == 0 && x > 50  && x < 70  ) down = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))-0.031077833846211433 ;
      else if(flavor == 0 && x > 70  && x < 100 ) down = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))-0.027616133913397789 ;
      else if(flavor == 0 && x > 100 && x < 140 ) down = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))-0.031399231404066086 ;
      else if(flavor == 0 && x > 140 && x < 200 ) down = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))-0.034734658896923065 ;
      else if(flavor == 0 && x > 200 && x < 300 ) down = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))-0.044301345944404602 ;
      else if(flavor == 0 && x > 300 && x < 600 ) down = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))-0.050837442278862    ;
      else if(flavor == 0 && x > 600 && x < 1000) down = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))-0.040907666087150574 ;
      if     (flavor == 1 && x > 20  && x < 30  ) up   = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))+0.29166096448898315  ;
      else if(flavor == 1 && x > 30  && x < 50  ) up   = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))+0.11922945827245712  ;
      else if(flavor == 1 && x > 50  && x < 70  ) up   = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))+0.10877241939306259  ;
      else if(flavor == 1 && x > 70  && x < 100 ) up   = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))+0.096656471490859985 ;
      else if(flavor == 1 && x > 100 && x < 140 ) up   = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))+0.10989730805158615  ;
      else if(flavor == 1 && x > 140 && x < 200 ) up   = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))+0.12157130241394043  ;
      else if(flavor == 1 && x > 200 && x < 300 ) up   = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))+0.1550547182559967   ;
      else if(flavor == 1 && x > 300 && x < 600 ) up   = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))+0.1779310405254364   ;
      else if(flavor == 1 && x > 600 && x < 1000) up   = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))+0.14317682385444641  ;
      else if(flavor == 0 && x > 20  && x < 30  ) up   = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))+0.083331704139709473 ;
      else if(flavor == 0 && x > 30  && x < 50  ) up   = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))+0.034065559506416321 ;
      else if(flavor == 0 && x > 50  && x < 70  ) up   = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))+0.031077833846211433 ;
      else if(flavor == 0 && x > 70  && x < 100 ) up   = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))+0.027616133913397789 ;
      else if(flavor == 0 && x > 100 && x < 140 ) up   = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))+0.031399231404066086 ;
      else if(flavor == 0 && x > 140 && x < 200 ) up   = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))+0.034734658896923065 ;
      else if(flavor == 0 && x > 200 && x < 300 ) up   = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))+0.044301345944404602 ;
      else if(flavor == 0 && x > 300 && x < 600 ) up   = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))+0.050837442278862    ;
      else if(flavor == 0 && x > 600 && x < 1000) up   = (0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x))))+0.040907666087150574 ;

      if(flavor == 2 && x > 20 && x < 1000) down = (0.952956+0.000569069*x+-1.88872e-06*x*x+1.25729e-09*x*x*x)*(1-(0.232956+0.000143975*x+-1.66524e-07*x*x));
      if(flavor == 2 && x > 20 && x < 1000) up   = (0.952956+0.000569069*x+-1.88872e-06*x*x+1.25729e-09*x*x*x)*(1+(0.232956+0.000143975*x+-1.66524e-07*x*x));
    }
  }

  ///////////////////////////////////////////
  // 2016 Systematics
  ///////////////////////////////////////////

  if(year == 2016) {

    ///////////////////////////////////////////
    // 2016 Loose WP
    if(WP == kLooseBTag) {
      if     (flavor == 1 && x > 20  && x < 30  )  down = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))-0.061678234487771988;
      else if(flavor == 1 && x > 30  && x < 50  )  down = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))-0.032233506441116333;
      else if(flavor == 1 && x > 50  && x < 70  )  down = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))-0.030768521130084991;
      else if(flavor == 1 && x > 70  && x < 100 )  down = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))-0.029403112828731537;
      else if(flavor == 1 && x > 100 && x < 140 )  down = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))-0.029279418289661407;
      else if(flavor == 1 && x > 140 && x < 200 )  down = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))-0.030047547072172165;
      else if(flavor == 1 && x > 200 && x < 300 )  down = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))-0.034353077411651611;
      else if(flavor == 1 && x > 300 && x < 600 )  down = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))-0.068900331854820251;
      else if(flavor == 1 && x > 600 && x < 1000)  down = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))-0.14984135329723358;
      else if(flavor == 0 && x > 20  && x < 30  )  down = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))-0.024671293795108795;
      else if(flavor == 0 && x > 30  && x < 50  )  down = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))-0.012893402948975563;
      else if(flavor == 0 && x > 50  && x < 70  )  down = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))-0.012307408265769482;
      else if(flavor == 0 && x > 70  && x < 100 )  down = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))-0.01176124531775713;
      else if(flavor == 0 && x > 100 && x < 140 )  down = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))-0.011711766943335533;
      else if(flavor == 0 && x > 140 && x < 200 )  down = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))-0.012019018642604351;
      else if(flavor == 0 && x > 200 && x < 300 )  down = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))-0.013741230592131615;
      else if(flavor == 0 && x > 300 && x < 600 )  down = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))-0.02756013348698616;
      else if(flavor == 0 && x > 600 && x < 1000)  down = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))-0.059936542063951492;
      if     (flavor == 1 && x > 20  && x < 30  )  up   = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))+0.061678234487771988;
      else if(flavor == 1 && x > 30  && x < 50  )  up   = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))+0.032233506441116333;
      else if(flavor == 1 && x > 50  && x < 70  )  up   = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))+0.030768521130084991;
      else if(flavor == 1 && x > 70  && x < 100 )  up   = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))+0.029403112828731537;
      else if(flavor == 1 && x > 100 && x < 140 )  up   = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))+0.029279418289661407;
      else if(flavor == 1 && x > 140 && x < 200 )  up   = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))+0.030047547072172165;
      else if(flavor == 1 && x > 200 && x < 300 )  up   = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))+0.034353077411651611;
      else if(flavor == 1 && x > 300 && x < 600 )  up   = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))+0.068900331854820251;
      else if(flavor == 1 && x > 600 && x < 1000)  up   = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))+0.14984135329723358;
      else if(flavor == 0 && x > 20  && x < 30  )  up   = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))+0.024671293795108795;
      else if(flavor == 0 && x > 30  && x < 50  )  up   = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))+0.012893402948975563;
      else if(flavor == 0 && x > 50  && x < 70  )  up   = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))+0.012307408265769482;
      else if(flavor == 0 && x > 70  && x < 100 )  up   = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))+0.01176124531775713;
      else if(flavor == 0 && x > 100 && x < 140 )  up   = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))+0.011711766943335533;
      else if(flavor == 0 && x > 140 && x < 200 )  up   = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))+0.012019018642604351;
      else if(flavor == 0 && x > 200 && x < 300 )  up   = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))+0.013741230592131615;
      else if(flavor == 0 && x > 300 && x < 600 )  up   = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))+0.02756013348698616;
      else if(flavor == 0 && x > 600 && x < 1000)  up   = (0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x))))+0.059936542063951492;

      if(flavor == 2 && x > 20 && x < 1000) down = (1.03726+0.000218815*x+-6.70561e-11*x*x+2.15167/x)*(1-(0.049251+8.04227e-05*x+-1.1138e-07*x*x));
      if(flavor == 2 && x > 20 && x < 1000) up   = (1.03726+0.000218815*x+-6.70561e-11*x*x+2.15167/x)*(1+(0.049251+8.04227e-05*x+-1.1138e-07*x*x));
      // if(flavor == 2 && x > 20 && x < 1000) down_correlated = (1.03726+0.000218815*x+-6.70561e-11*x*x+2.15167/x)*(1-(0.0472277+8.38862e-05*x+-1.16149e-07*x*x));
      // if(flavor == 2 && x > 20 && x < 1000) up_correlated   = (1.03726+0.000218815*x+-6.70561e-11*x*x+2.15167/x)*(1+(0.0472277+8.38862e-05*x+-1.16149e-07*x*x));
      // if(flavor == 2 && x > 20 && x < 1000) down_uncorrelated = (1.03726+0.000218815*x+-6.70561e-11*x*x+2.15167/x)*(1-(0.0139966));
      // if(flavor == 2 && x > 20 && x < 1000) up_uncorrelated   = (1.03726+0.000218815*x+-6.70561e-11*x*x+2.15167/x)*(1+(0.0139966));
    }

    ///////////////////////////////////////////
    // 2016 Medium WP
    if(WP == kMediumBTag) {
      if     (flavor == 1 && x > 20  && x < 30  )  down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.13967660069465637 ;
      else if(flavor == 1 && x > 30  && x < 50  )  down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.049122259020805359;
      else if(flavor == 1 && x > 50  && x < 70  )  down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.043598789721727371;
      else if(flavor == 1 && x > 70  && x < 100 )  down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.038782715797424316;
      else if(flavor == 1 && x > 100 && x < 140 )  down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.036949444562196732;
      else if(flavor == 1 && x > 140 && x < 200 )  down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.043523617088794708;
      else if(flavor == 1 && x > 200 && x < 300 )  down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.04994809627532959 ;
      else if(flavor == 1 && x > 300 && x < 600 )  down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.090836621820926666;
      else if(flavor == 1 && x > 600 && x < 1000)  down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.16102308034896851 ;
      else if(flavor == 0 && x > 20  && x < 30  )  down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.046558864414691925;
      else if(flavor == 0 && x > 30  && x < 50  )  down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.016374086961150169;
      else if(flavor == 0 && x > 50  && x < 70  )  down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.014532930217683315;
      else if(flavor == 0 && x > 70  && x < 100 )  down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.012927571311593056;
      else if(flavor == 0 && x > 100 && x < 140 )  down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.012316481210291386;
      else if(flavor == 0 && x > 140 && x < 200 )  down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.014507872052490711;
      else if(flavor == 0 && x > 200 && x < 300 )  down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.016649365425109863;
      else if(flavor == 0 && x > 300 && x < 600 )  down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.030278874561190605;
      else if(flavor == 0 && x > 600 && x < 1000)  down = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))-0.053674362599849701;
      if     (flavor == 1 && x > 20  && x < 30  )  up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.13967660069465637 ;
      else if(flavor == 1 && x > 30  && x < 50  )  up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.049122259020805359;
      else if(flavor == 1 && x > 50  && x < 70  )  up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.043598789721727371;
      else if(flavor == 1 && x > 70  && x < 100 )  up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.038782715797424316;
      else if(flavor == 1 && x > 100 && x < 140 )  up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.036949444562196732;
      else if(flavor == 1 && x > 140 && x < 200 )  up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.043523617088794708;
      else if(flavor == 1 && x > 200 && x < 300 )  up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.04994809627532959 ;
      else if(flavor == 1 && x > 300 && x < 600 )  up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.090836621820926666;
      else if(flavor == 1 && x > 600 && x < 1000)  up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.16102308034896851 ;
      else if(flavor == 0 && x > 20  && x < 30  )  up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.046558864414691925;
      else if(flavor == 0 && x > 30  && x < 50  )  up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.016374086961150169;
      else if(flavor == 0 && x > 50  && x < 70  )  up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.014532930217683315;
      else if(flavor == 0 && x > 70  && x < 100 )  up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.012927571311593056;
      else if(flavor == 0 && x > 100 && x < 140 )  up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.012316481210291386;
      else if(flavor == 0 && x > 140 && x < 200 )  up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.014507872052490711;
      else if(flavor == 0 && x > 200 && x < 300 )  up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.016649365425109863;
      else if(flavor == 0 && x > 300 && x < 600 )  up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.030278874561190605;
      else if(flavor == 0 && x > 600 && x < 1000)  up   = (0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x))))+0.053674362599849701;

      if(flavor == 2 && x > 20 && x < 1000) down = (1.09149+3.31851e-05*x+2.34826e-07*x*x+-0.888846/x)*(1-(0.127379+0.000199537*x+-2.43111e-07*x*x));
      if(flavor == 2 && x > 20 && x < 1000) up   = (1.09149+3.31851e-05*x+2.34826e-07*x*x+-0.888846/x)*(1+(0.127379+0.000199537*x+-2.43111e-07*x*x));
      // if(flavor == 2 && x > 20 && x < 1000) down_correlated = (1.09149+3.31851e-05*x+2.34826e-07*x*x+-0.888846/x)*(1-(0.110108+0.000225709*x+-2.74882e-07*x*x));
      // if(flavor == 2 && x > 20 && x < 1000) up_correlated   = (1.09149+3.31851e-05*x+2.34826e-07*x*x+-0.888846/x)*(1+(0.110108+0.000225709*x+-2.74882e-07*x*x));
      // if(flavor == 2 && x > 20 && x < 1000) down_uncorrelated = (1.09149+3.31851e-05*x+2.34826e-07*x*x+-0.888846/x)*(1-(0.0644695));
      // if(flavor == 2 && x > 20 && x < 1000) up_uncorrelated   = (1.09149+3.31851e-05*x+2.34826e-07*x*x+-0.888846/x)*(1+(0.0644695));
    }

    ///////////////////////////////////////////
    // 2016 Tight WP
    if(WP == kTightBTag) {
      if     (flavor == 1 && x > 20  && x < 30  )  down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.15082257986068726 ;
      else if(flavor == 1 && x > 30  && x < 50  )  down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.054858319461345673;
      else if(flavor == 1 && x > 50  && x < 70  )  down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.053491078317165375;
      else if(flavor == 1 && x > 70  && x < 100 )  down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.048742711544036865;
      else if(flavor == 1 && x > 100 && x < 140 )  down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.04667256772518158 ;
      else if(flavor == 1 && x > 140 && x < 200 )  down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.047940321266651154;
      else if(flavor == 1 && x > 200 && x < 300 )  down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.064067237079143524;
      else if(flavor == 1 && x > 300 && x < 600 )  down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.10955213010311127 ;
      else if(flavor == 1 && x > 600 && x < 1000)  down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.16617907583713531 ;
      else if(flavor == 0 && x > 20  && x < 30  )  down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.043092165142297745;
      else if(flavor == 0 && x > 30  && x < 50  )  down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.01567380502820015 ;
      else if(flavor == 0 && x > 50  && x < 70  )  down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.015283165499567986;
      else if(flavor == 0 && x > 70  && x < 100 )  down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.013926489278674126;
      else if(flavor == 0 && x > 100 && x < 140 )  down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.01333501935005188 ;
      else if(flavor == 0 && x > 140 && x < 200 )  down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.013697234913706779;
      else if(flavor == 0 && x > 200 && x < 300 )  down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.018304925411939621;
      else if(flavor == 0 && x > 300 && x < 600 )  down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.031300608068704605;
      else if(flavor == 0 && x > 600 && x < 1000)  down = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))-0.047479737550020218;
      if     (flavor == 1 && x > 20  && x < 30  )  up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.15082257986068726 ;
      else if(flavor == 1 && x > 30  && x < 50  )  up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.054858319461345673;
      else if(flavor == 1 && x > 50  && x < 70  )  up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.053491078317165375;
      else if(flavor == 1 && x > 70  && x < 100 )  up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.048742711544036865;
      else if(flavor == 1 && x > 100 && x < 140 )  up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.04667256772518158 ;
      else if(flavor == 1 && x > 140 && x < 200 )  up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.047940321266651154;
      else if(flavor == 1 && x > 200 && x < 300 )  up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.064067237079143524;
      else if(flavor == 1 && x > 300 && x < 600 )  up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.10955213010311127 ;
      else if(flavor == 1 && x > 600 && x < 1000)  up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.16617907583713531 ;
      else if(flavor == 0 && x > 20  && x < 30  )  up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.043092165142297745;
      else if(flavor == 0 && x > 30  && x < 50  )  up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.01567380502820015 ;
      else if(flavor == 0 && x > 50  && x < 70  )  up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.015283165499567986;
      else if(flavor == 0 && x > 70  && x < 100 )  up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.013926489278674126;
      else if(flavor == 0 && x > 100 && x < 140 )  up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.01333501935005188 ;
      else if(flavor == 0 && x > 140 && x < 200 )  up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.013697234913706779;
      else if(flavor == 0 && x > 200 && x < 300 )  up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.018304925411939621;
      else if(flavor == 0 && x > 300 && x < 600 )  up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.031300608068704605;
      else if(flavor == 0 && x > 600 && x < 1000)  up   = (0.573021*((1.+(0.472221*x))/(1.+(0.27584*x))))+0.047479737550020218;

      if(flavor == 2 && x > 20 && x < 1000) down = (1.09741+-0.000871879*x+2.20312e-06*x*x+-1.53037e-09*x*x*x)*(1-(0.230419+0.000263021*x+-2.85751e-07*x*x));
      if(flavor == 2 && x > 20 && x < 1000) up   = (1.09741+-0.000871879*x+2.20312e-06*x*x+-1.53037e-09*x*x*x)*(1+(0.230419+0.000263021*x+-2.85751e-07*x*x));
      // if(flavor == 2 && x > 20 && x < 1000) down_correlated = (1.09741+-0.000871879*x+2.20312e-06*x*x+-1.53037e-09*x*x*x)*(1-(0.17528+0.000312862*x+-3.44379e-07*x*x));
      // if(flavor == 2 && x > 20 && x < 1000) up_correlated   = (1.09741+-0.000871879*x+2.20312e-06*x*x+-1.53037e-09*x*x*x)*(1+(0.17528+0.000312862*x+-3.44379e-07*x*x))
      // if(flavor == 2 && x > 20 && x < 1000) down_uncorrelated = (1.09741+-0.000871879*x+2.20312e-06*x*x+-1.53037e-09*x*x*x)*(1-(0.156054));
      // if(flavor == 2 && x > 20 && x < 1000) up_uncorrelated   = (1.09741+-0.000871879*x+2.20312e-06*x*x+-1.53037e-09*x*x*x)*(1+(0.156054));
    }
  }
}

//-------------------------------------------------------------------------------------------------------------------------
// Get the scale factor to apply to MC
float BTagWeight::GetScaleFactor(const int WP, const int year, float jetpt, int jetFlavor, float& up, float& down) {
  float scale_factor(1.), x(jetpt); //use x here, seems like it should be pT?
  x = std::max(20.001f, std::min(999.f, x));
  jetFlavor = abs(jetFlavor);

  //In CSV file: type 0 is b, type 1 is c, and type 2 is light
  if(jetFlavor == 5 || jetFlavor == 4) { //true b-jets and c-jets (since corrections the same)
    if(year == 2016) {
      if(WP == kLooseBTag)       scale_factor = 0.971065*((1.+(0.0100459*x))/(1.+(0.00975219*x)));
      else if(WP == kMediumBTag) scale_factor = 0.922748*((1.+(0.0241884*x))/(1.+(0.0223119*x)));
      else if(WP == kTightBTag)  scale_factor = 0.573021*((1.+(0.472221*x))/(1.+(0.27584*x)));
    } else if(year == 2017) {
      if(WP == kLooseBTag)       scale_factor = 1.04891*((1.+(0.0145976*x))/(1.+(0.0165274*x)));
      else if(WP == kMediumBTag) scale_factor = 0.991757*((1.+(0.0209615*x))/(1.+(0.0234962*x)));
      else if(WP == kTightBTag)  scale_factor = 0.908648*((1.+(0.00516407*x))/(1.+(0.00564675*x)));
    } else if(year == 2018) {
      if(WP == kLooseBTag)       scale_factor = 0.873139+(0.00420739*(log(x+19.)*(log(x+18.)*(3-(0.380932*log(x+18.))))));
      else if(WP == kMediumBTag) scale_factor = 1.0097+(-(2.89663e-06*(log(x+19.)*(log(x+18.)*(3-(-(110.381*log(x+18.))))))));
      else if(WP == kTightBTag)  scale_factor = 0.818896+(0.00682971*(log(x+19.)*(log(x+18.)*(3-(0.440998*log(x+18.))))));
    }
  } else { //other (light) jets
    if(year == 2016) {
      if(WP == kLooseBTag)       scale_factor = 1.03726+0.000218815*x+-6.70561e-11*x*x+2.15167/x;
      else if(WP == kMediumBTag) scale_factor = 1.09149+3.31851e-05*x+2.34826e-07*x*x+-0.888846/x;
      else if(WP == kTightBTag)  scale_factor = 1.09741+-0.000871879*x+2.20312e-06*x*x+-1.53037e-09*x*x*x;
    } else if(year == 2017) {
      if(WP == kLooseBTag)       scale_factor = 1.43763+-0.000337048*x+2.22072e-07*x*x+-4.85489/x;
      else if(WP == kMediumBTag) scale_factor = 1.40779+-0.00094558*x+8.74982e-07*x*x+-4.67814/x;
      else if(WP == kTightBTag)  scale_factor = 0.952956+0.000569069*x+-1.88872e-06*x*x+1.25729e-09*x*x*x;
    } else if(year == 2018) {
      if(WP == kLooseBTag)       scale_factor = 1.61341+-0.000566321*x+1.99464e-07*x*x+-5.09199/x;
      else if(WP == kMediumBTag) scale_factor = 1.59373+-0.00113028*x+8.66631e-07*x*x+-1.10505/x;
      else if(WP == kTightBTag)  scale_factor = 1.77088+-0.00371551*x+5.86489e-06*x*x+-3.01178e-09*x*x*x;
    }
  }
  if(scale_factor < 0.01) scale_factor = 1.; //taken from btagSFProducer.py
  GetSystematic(WP, year, jetpt, jetFlavor, up, down);
  up   = (up   < 0.01) ? 1. : up  ;
  down = (down < 0.01) ? 1. : down;
  return scale_factor;
}

//-------------------------------------------------------------------------------------------------------------------------
// Get the overall weight for the event to apply to MC
float BTagWeight::GetWeight(const int wp, const int year, const int njets, const float* jetspt,
                            const float* jetseta, const int* jetsflavor, const int* jetsbtag,
                            float& up, float& down) {
  float weight(1.), prob_data(1.), prob_mc(1.);
  up = 1.; down = 1.;
  if(verbose_ > 0)
    printf(" BTagWeight::%s: Printing b-tag info for %i jets:\n", __func__, njets);
  for(int jet = 0; jet < njets; ++jet) {
    if(std::fabs(jetseta[jet]) > 2.4) continue; //not in accepted volume
    if(jetspt[jet] < 20.) continue; //below pT threshold
    float p_mc = GetMCEff(wp, year, jetspt[jet], jetseta[jet], jetsflavor[jet]);
    float i_up, i_down;
    float scale_factor = GetScaleFactor(wp, year, jetspt[jet], jetsflavor[jet], i_up, i_down);
    float p_data = std::max(0., std::min(1., (double) p_mc*scale_factor)); //0 <= probability <= 1
    if(jetsbtag[jet] > wp) { //passes this working point
      prob_data *= p_data;
      prob_mc   *= p_mc;
      up   *= std::max(0., std::min(1., (double) p_mc*i_up  ));
      down *= std::max(0., std::min(1., (double) p_mc*i_down));
    } else { //fails this working point
      prob_data *= 1. - p_data;
      prob_mc   *= 1. - p_mc;
      up   *= 1. - std::max(0., std::min(1., (double) p_mc*i_up  ));
      down *= 1. - std::max(0., std::min(1., (double) p_mc*i_down));
    }
    if(verbose_ > 0)
      printf(" Jet %2i: pt = %.2f eta = %.2f flavor = %i tagged = %i scale = %.3f up = %.3f down = %.3f\n",
             jet, jetspt[jet], jetseta[jet], jetsflavor[jet], jetsbtag[jet] > wp, scale_factor, i_up, i_down);
  }
  if(prob_mc > 0. && !std::isnan(prob_data) && !std::isnan(prob_mc)) {
    weight = prob_data / prob_mc;
    up   = (up   > 0.) ? up   / prob_mc : 1.;
    down = (down > 0.) ? down / prob_mc : 1.;
  } else {
    std::cout << "!!! BTagWeight::" << __func__ << ": weight undefined! Returning 1...\n";
    up   = 1.;
    down = 1.;
  }
  if(std::isnan(up)  ) up   = weight;
  if(std::isnan(down)) down = weight;
  if(verbose_ > 0) printf(" weight = %.3f up = %.3f down = %.3f\n", weight, up, down);
  return weight;
}
